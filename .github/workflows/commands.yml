name: 💬 Comment
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  parse_commands:
    runs-on: ubuntu-latest
    name: 👁️‍🗨️ Parse Commands
    steps:
    - id: parser
      uses: tilde-love/git-gud/parser@main
      with:
        commands: '[ "/help", "/complete", "/publish", "/next", "/approve" ]'
        allowed-associations: '[ "OWNER", "MEMBER" ]'
    outputs:
      has_commands: steps.parser.outputs.parsed !== "[]"
      command_matrix: ${{ steps.parser.outputs.parsed }}

  command:
    needs: parse_commands
    if: needs.parse_commands.outputs.has_commands
    name: 🔧 ${{ matrix.commands[0] }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      repository-projects: write

    strategy:
      fail-fast: true
      max-parallel: 1
      matrix:
        commands: ${{ fromJson(needs.parse_commands.outputs.command_matrix) }}

    steps:

    - name: 💖 Setup next release branch
      if: ${{ '/next' == matrix.commands[0] }}
      uses: tilde-love/git-gud/next@main

    - name: 💎 Create pull request
      if: ${{ '/complete' == matrix.commands[0] }}
      uses: tilde-love/git-gud/complete@main
      with:
        branch: ${{ matrix.commands[1] }}

    - name: 🚀 Create release
      if: ${{ '/publish' == matrix.commands[0] }}
      uses: tilde-love/git-gud/publish@main
